{% extends "base.html" %}

{% block title %}Trailing Stops - {{ app_name }}{% endblock %}

{% block page_title %}Trailing Stop Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></li>
<li class="breadcrumb-item active">Trailing Stops</li>
{% endblock %}

{% block content %}
<!-- Bulk Actions Row -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-cogs mr-2"></i>Bulk Actions
        </h3>
      </div>
      <div class="card-body">
        <form id="bulk-form" method="post" action="{{ url_for('trailing_stops') }}">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-success" onclick="saveAllChanges()">
              <i class="fas fa-save"></i> Save All Changes
            </button>
            <button type="button" class="btn btn-danger" onclick="removeSelected()">
              <i class="fas fa-trash"></i> Remove Selected
            </button>
          </div>
          <div class="float-right">
            <button type="button" class="btn btn-primary" onclick="location.reload()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <span id="selected-count" class="ml-3 text-muted">0 selected</span>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-stop-circle mr-2"></i>Active Trailing Stops
        </h3>
        <div class="card-tools">
          <button type="button" class="btn btn-sm btn-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      <!-- /.card-header -->
      <div class="card-body">
        {% if trailing_stops %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th width="50">
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input" id="select_all">
                    <label class="custom-control-label" for="select_all"></label>
                  </div>
                </th>
                <th>Bot ID</th>
                <th>Bot Name</th>
                <th>Status</th>
                <th>Activation Threshold (%)</th>
                <th>Trailing Mode</th>
                <th>Trailing Value</th>
                <th>High Water Mark</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for trailing_stop in trailing_stops %}
              <tr data-bot-id="{{ trailing_stop.bot.id if trailing_stop.bot else '' }}">
                <td>
                  <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input bot-checkbox" 
                           id="bot_{{ trailing_stop.bot.id if trailing_stop.bot else trailing_stop.id }}" 
                           name="selected_bots" value="{{ trailing_stop.bot.id if trailing_stop.bot else '' }}">
                    <label class="custom-control-label" for="bot_{{ trailing_stop.bot.id if trailing_stop.bot else trailing_stop.id }}"></label>
                  </div>
                </td>
                <td>
                  {% if trailing_stop.bot %}
                    {{ trailing_stop.bot.id }}
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if trailing_stop.bot %}
                    <a href="{{ url_for('bot_detail', bot_id=trailing_stop.bot.id) }}">
                      {{ trailing_stop.bot.name }}
                    </a>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge-{{ trailing_stop.status_badge_class }}">
                    {{ trailing_stop.status_text }}
                  </span>
                </td>
                <td>
                  {% if trailing_stop.activation_threshold %}
                    <input type="number" step="0.01" 
                           class="form-control form-control-sm editable-field" 
                           style="width: 80px; display: inline-block;"
                           data-field="activation_threshold"
                           data-bot-id="{{ trailing_stop.bot.id if trailing_stop.bot else '' }}"
                           value="{{ "%.2f"|format(trailing_stop.activation_threshold) }}">
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge-{{ 'primary' if trailing_stop.trailing_mode == 'percentage' else 'warning' }}">
                    {{ trailing_stop.trailing_mode|upper if trailing_stop.trailing_mode else 'PERCENTAGE' }}
                  </span>
                </td>
                <td>
                  {% if trailing_stop.trailing_mode == 'dollar' and trailing_stop.trailing_dollar_amount %}
                    <input type="number" step="0.01" 
                           class="form-control form-control-sm editable-field" 
                           style="width: 80px; display: inline-block;"
                           data-field="trailing_dollar_amount"
                           data-bot-id="{{ trailing_stop.bot.id if trailing_stop.bot else '' }}"
                           value="{{ "%.2f"|format(trailing_stop.trailing_dollar_amount) }}">
                    <span class="text-muted ml-1">$</span>
                  {% elif trailing_stop.trailing_percentage %}
                    <input type="number" step="0.01" 
                           class="form-control form-control-sm editable-field" 
                           style="width: 80px; display: inline-block;"
                           data-field="trailing_percentage"
                           data-bot-id="{{ trailing_stop.bot.id if trailing_stop.bot else '' }}"
                           value="{{ "%.2f"|format(trailing_stop.trailing_percentage) }}">
                    <span class="text-muted ml-1">%</span>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if trailing_stop.high_water_mark %}
                    ${{ "%.2f"|format(trailing_stop.high_water_mark) }}
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if trailing_stop.high_water_mark %}
                    ${{ "%.2f"|format(trailing_stop.high_water_mark) }}
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-success btn-sm save-btn" 
                            data-bot-id="{{ trailing_stop.bot.id if trailing_stop.bot else '' }}"
                            title="Save Changes">
                      <i class="fas fa-save"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm remove-btn" 
                            data-bot-id="{{ trailing_stop.bot.id if trailing_stop.bot else '' }}"
                            title="Remove Trailing Stop">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">
          <h5><i class="icon fas fa-info"></i> No Trailing Stops Found!</h5>
          No trailing stops are currently configured in the system.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Statistics -->
<div class="row">
  <div class="col-lg-3 col-6">
    <div class="small-box bg-info">
      <div class="inner">
        <h3>{{ trailing_stops|length }}</h3>
        <p>Total Trailing Stops</p>
      </div>
      <div class="icon">
        <i class="fas fa-stop-circle"></i>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-6">
    <div class="small-box bg-success">
      <div class="inner">
        <h3>{{ trailing_stops|selectattr('is_active')|list|length }}</h3>
        <p>Active Trailing Stops</p>
      </div>
      <div class="icon">
        <i class="fas fa-play-circle"></i>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-6">
    <div class="small-box bg-secondary">
      <div class="inner">
        <h3>{{ trailing_stops|rejectattr('is_active')|list|length }}</h3>
        <p>Inactive Trailing Stops</p>
      </div>
      <div class="icon">
        <i class="fas fa-pause-circle"></i>
      </div>
    </div>
  </div>
  
  <div class="col-lg-3 col-6">
    <div class="small-box bg-warning">
      <div class="inner">
        <h3>{{ bots|length }}</h3>
        <p>Associated Bots</p>
      </div>
      <div class="icon">
        <i class="fas fa-robot"></i>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Handle select all checkbox
    $('#select_all').change(function() {
        $('.bot-checkbox').prop('checked', $(this).is(':checked'));
        updateSelectedCount();
    });

    // Handle individual checkbox changes
    $('.bot-checkbox').change(function() {
        updateSelectedCount();
        
        // Update select all checkbox state
        const totalCheckboxes = $('.bot-checkbox').length;
        const checkedCheckboxes = $('.bot-checkbox:checked').length;
        
        if (checkedCheckboxes === 0) {
            $('#select_all').prop('indeterminate', false).prop('checked', false);
        } else if (checkedCheckboxes === totalCheckboxes) {
            $('#select_all').prop('indeterminate', false).prop('checked', true);
        } else {
            $('#select_all').prop('indeterminate', true).prop('checked', false);
        }
    });

    function updateSelectedCount() {
        const count = $('.bot-checkbox:checked').length;
        $('#selected-count').text(count + ' selected');
    }

    // Individual save button
    $('.save-btn').click(function() {
        const botId = $(this).data('bot-id');
        saveTrailingStop(botId);
    });

    // Individual remove button
    $('.remove-btn').click(function() {
        const botId = $(this).data('bot-id');
        if (confirm('Remove trailing stop for this bot?')) {
            removeTrailingStop(botId);
        }
    });

    // Highlight changed fields
    $('.editable-field').on('input', function() {
        $(this).addClass('border-warning');
    });

    function saveTrailingStop(botId) {
        const row = $(`tr[data-bot-id="${botId}"]`);
        const activationThreshold = row.find('input[data-field="activation_threshold"]').val();
        const trailingPercentage = row.find('input[data-field="trailing_percentage"]').val();
        const trailingDollarAmount = row.find('input[data-field="trailing_dollar_amount"]').val();
        
        // Determine mode based on which field has a value
        let trailingMode = 'percentage';
        let hasPercentage = trailingPercentage && parseFloat(trailingPercentage) > 0;
        let hasDollar = trailingDollarAmount && parseFloat(trailingDollarAmount) > 0;
        
        if (hasDollar) {
            trailingMode = 'dollar';
        }
        
        if (!activationThreshold) {
            alert('Please enter activation threshold.');
            return;
        }
        
        if (!hasPercentage && !hasDollar) {
            alert('Please enter either trailing percentage or trailing dollar amount.');
            return;
        }

        $.ajax({
            url: '{{ url_for("update_trailing_stop") }}',
            method: 'POST',
            data: {
                bot_id: botId,
                activation_threshold: activationThreshold,
                trailing_mode: trailingMode,
                trailing_percentage: trailingPercentage || null,
                trailing_dollar_amount: trailingDollarAmount || null
            },
            success: function(response) {
                if (response.success) {
                    // Remove warning border
                    row.find('.editable-field').removeClass('border-warning');
                    showMessage('Trailing stop updated successfully', 'success');
                } else {
                    showMessage('Failed to update trailing stop: ' + response.message, 'danger');
                }
            },
            error: function() {
                showMessage('Error updating trailing stop', 'danger');
            }
        });
    }

    function removeTrailingStop(botId) {
        $.ajax({
            url: '{{ url_for("remove_trailing_stop") }}',
            method: 'POST',
            data: {
                bot_id: botId
            },
            success: function(response) {
                if (response.success) {
                    $(`tr[data-bot-id="${botId}"]`).fadeOut(function() {
                        $(this).remove();
                        updateSelectedCount();
                    });
                    showMessage('Trailing stop removed successfully', 'success');
                } else {
                    showMessage('Failed to remove trailing stop: ' + response.message, 'danger');
                }
            },
            error: function() {
                showMessage('Error removing trailing stop', 'danger');
            }
        });
    }

    function showMessage(message, type) {
        // Create a temporary alert
        let alertClass;
        switch(type) {
            case 'success':
                alertClass = 'alert-success';
                break;
            case 'warning':
                alertClass = 'alert-warning';
                break;
            case 'danger':
            default:
                alertClass = 'alert-danger';
                break;
        }
        
        const alert = $(`<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>`);
        
        $('.card-body').prepend(alert);
        
        // Auto-dismiss after 5 seconds for warning/error messages
        const dismissTime = type === 'success' ? 3000 : 5000;
        setTimeout(() => {
            alert.alert('close');
        }, dismissTime);
    }

    // Initial count update
    updateSelectedCount();
});

// Global functions for bulk actions
function saveAllChanges() {
    const changedRows = $('.editable-field.border-warning').closest('tr');
    if (changedRows.length === 0) {
        alert('No changes to save.');
        return;
    }
    
    if (confirm(`Save changes for ${changedRows.length} trailing stop(s)?`)) {
        changedRows.each(function() {
            const botId = $(this).data('bot-id');
            const saveBtn = $(this).find('.save-btn');
            saveBtn.click();
        });
    }
}

function removeSelected() {
    const selectedBots = $('.bot-checkbox:checked');
    if (selectedBots.length === 0) {
        alert('Please select at least one trailing stop to remove.');
        return;
    }
    
    if (confirm(`Remove ${selectedBots.length} trailing stop(s)? This cannot be undone.`)) {
        let completedRequests = 0;
        let successCount = 0;
        let failedBots = [];
        
        selectedBots.each(function() {
            const botId = $(this).val();
            const row = $(this).closest('tr');
            
            $.ajax({
                url: '{{ url_for("remove_trailing_stop") }}',
                method: 'POST',
                data: {
                    bot_id: botId
                },
                success: function(response) {
                    completedRequests++;
                    if (response.success) {
                        successCount++;
                        row.fadeOut(function() {
                            $(this).remove();
                            updateSelectedCount();
                        });
                    } else {
                        failedBots.push(`Bot ${botId}: ${response.message}`);
                    }
                    
                    // Check if all requests are complete
                    if (completedRequests === selectedBots.length) {
                        let message = `${successCount} trailing stop(s) removed successfully.`;
                        if (failedBots.length > 0) {
                            message += ` Failed: ${failedBots.join(', ')}`;
                        }
                        showMessage(message, failedBots.length > 0 ? 'warning' : 'success');
                    }
                },
                error: function() {
                    completedRequests++;
                    failedBots.push(`Bot ${botId}: Network error`);
                    
                    // Check if all requests are complete
                    if (completedRequests === selectedBots.length) {
                        let message = `${successCount} trailing stop(s) removed successfully.`;
                        if (failedBots.length > 0) {
                            message += ` Failed: ${failedBots.join(', ')}`;
                        }
                        showMessage(message, 'warning');
                    }
                }
            });
        });
    }
}
</script>
{% endblock %}