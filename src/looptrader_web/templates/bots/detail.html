{% extends "base.html" %}

{% block title %}Bot {{ bot.name }} - {{ app_name }}{% endblock %}

{% block page_title %}Bot Details{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('bots') }}">Bots</a></li>
<li class="breadcrumb-item active">{{ bot.name }}</li>
{% endblock %}

{% block content %}
<!-- Bot Information Cards -->
<div class="row">
  <!-- Bot Basic Info -->
  <div class="col-md-6">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-robot mr-2"></i>Bot Information
        </h3>
      </div>
      <div class="card-body">
        <table class="table table-borderless">
          <tr>
            <td><strong>Name:</strong></td>
            <td>{{ bot.name }}</td>
          </tr>
          <tr>
            <td><strong>ID:</strong></td>
            <td>{{ bot.id }}</td>
          </tr>
          <tr>
            <td><strong>Status:</strong></td>
            <td>
              <span class="badge badge-{{ bot.status_badge_class }}">
                {{ bot.status_text }}
              </span>
            </td>
          </tr>
          <tr>
            <td><strong>State:</strong></td>
            <td>
              <span class="badge badge-{{ bot.state_badge_class }}">
                {{ bot.state }}
              </span>
            </td>
          </tr>
          <tr>
            <td>
              <strong>Trailing Stop:</strong>
            </td>
            <td>
              {% if bot.has_trailing_stop %}
                <span class="badge badge-{{ bot.trailing_stop_state.status_badge_class }}">
                  {{ bot.trailing_stop_state.status_text }}
                </span>
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td><strong>Account:</strong></td>
            <td>{{ bot.account_name }}</td>
          </tr>
        </table>
      </div>
    </div>
    <!-- Edit Bot -->
    <div class="card card-outline card-secondary mt-3">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-edit mr-2"></i>Edit Bot</h3></div>
      <div class="card-body">
        <form method="post" action="{{ url_for('update_bot_route', bot_id=bot.id) }}">
          <div class="form-group">
            <label for="botName">Name</label>
            <input type="text" class="form-control" id="botName" name="name" value="{{ bot.name }}" required>
          </div>
          <div class="form-row">
            <div class="form-group col-6">
              <label>Enabled</label>
              <select name="enabled" class="form-control">
                <option value="true" {% if bot.enabled %}selected{% endif %}>True</option>
                <option value="false" {% if not bot.enabled %}selected{% endif %}>False</option>
              </select>
            </div>
            <div class="form-group col-6">
              <label>Paused</label>
              <select name="paused" class="form-control">
                <option value="true" {% if bot.paused %}selected{% endif %}>True</option>
                <option value="false" {% if not bot.paused %}selected{% endif %}>False</option>
              </select>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-save"></i> Save Bot</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bot Controls -->
  <div class="col-md-6">
    <div class="card card-warning">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-cogs mr-2"></i>Bot Controls
        </h3>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-12">
            <h5>Bot Actions</h5>
            <div class="btn-group d-block" role="group">
              {% if bot.paused %}
                <button class="btn btn-success btn-block mb-2" onclick="resumeBot({{ bot.id }})">
                  <i class="fas fa-play"></i> Resume Bot
                </button>
              {% elif bot.enabled %}
                <button class="btn btn-warning btn-block mb-2" onclick="pauseBot({{ bot.id }})">
                  <i class="fas fa-pause"></i> Pause Bot
                </button>
              {% else %}
                <button class="btn btn-secondary btn-block mb-2" onclick="enableBot({{ bot.id }})">
                  <i class="fas fa-power-off"></i> Enable Bot
                </button>
              {% endif %}
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-6">
            <div class="description-block border-right">
              <span class="description-percentage text-success">
                <i class="fas fa-chart-line"></i>
              </span>
              <h5 class="description-header">{{ bot.active_positions_count }}</h5>
              <span class="description-text">ACTIVE POSITIONS</span>
            </div>
          </div>
          <div class="col-6">
            <div class="description-block">
              <span class="description-percentage text-info">
                <i class="fas fa-history"></i>
              </span>
              <h5 class="description-header">{{ bot.positions|length }}</h5>
              <span class="description-text">TOTAL POSITIONS</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Trailing Stop Information -->
{% if bot.has_trailing_stop %}
<div class="row">
  <div class="col-12">
    <div class="card card-info">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-chart-line mr-2"></i>Trailing Stop Configuration
        </h3>
        <div class="card-tools">
          <form method="post" action="{{ url_for('delete_trailing_stop_route', bot_id=bot.id) }}" onsubmit="return confirm('Remove trailing stop for this bot?');" style="display:inline;">
            <button type="submit" class="btn btn-tool text-danger" title="Remove Trailing Stop">
              <i class="fas fa-trash"></i>
            </button>
          </form>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-2">
            <div class="description-block border-right">
              <h5 class="description-header">{{ bot.trailing_stop_state.activation_threshold }}%</h5>
              <span class="description-text">ACTIVATION THRESHOLD</span>
            </div>
          </div>
          <div class="col-md-2">
            <div class="description-block border-right">
              <h5 class="description-header">
                <span class="badge badge-{{ 'primary' if bot.trailing_stop_state.trailing_mode == 'percentage' else 'warning' }}">
                  {{ bot.trailing_stop_state.trailing_mode|upper if bot.trailing_stop_state.trailing_mode else 'PERCENTAGE' }}
                </span>
              </h5>
              <span class="description-text">MODE</span>
            </div>
          </div>
          <div class="col-md-2">
            <div class="description-block border-right">
              <h5 class="description-header">{{ bot.trailing_stop_state.trailing_display }}</h5>
              <span class="description-text">TRAILING VALUE</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="description-block border-right">
              <h5 class="description-header">
                <span class="badge badge-{{ bot.trailing_stop_state.status_badge_class }}">
                  {{ bot.trailing_stop_state.status_text }}
                </span>
              </h5>
              <span class="description-text">STATUS</span>
            </div>
          </div>
          <div class="col-md-3">
            <div class="description-block">
              <h5 class="description-header">
                {% if bot.trailing_stop_state.high_water_mark %}
                  ${{ "%.2f"|format(bot.trailing_stop_state.high_water_mark) }}
                {% else %}
                  N/A
                {% endif %}
              </h5>
              <span class="description-text">HIGH WATER MARK</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Trailing Stop Form -->
<div class="row">
  <div class="col-md-6">
    <div class="card card-outline card-info">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-sliders-h mr-2"></i>{% if bot.has_trailing_stop %}Update{% else %}Add{% endif %} Trailing Stop</h3></div>
      <div class="card-body">
        <form method="post" action="{{ url_for('upsert_trailing_stop_route', bot_id=bot.id) }}" id="trailing-stop-form">
          <div class="form-group">
            <label>Activation Threshold (%)</label>
            <input type="number" step="0.01" name="activation_threshold" id="activation_threshold" class="form-control" value="{{ bot.trailing_stop_state.activation_threshold if bot.has_trailing_stop else '' }}" required>
          </div>
          <div class="form-group">
            <label>Trailing Mode</label>
            <select name="trailing_mode" id="trailing_mode" class="form-control">
              <option value="percentage" {% if not bot.has_trailing_stop or bot.trailing_stop_state.trailing_mode == 'percentage' %}selected{% endif %}>Percentage</option>
              <option value="dollar" {% if bot.has_trailing_stop and bot.trailing_stop_state.trailing_mode == 'dollar' %}selected{% endif %}>Dollar Amount</option>
            </select>
          </div>
          <div class="form-group" id="percentage_field" {% if bot.has_trailing_stop and bot.trailing_stop_state.trailing_mode == 'dollar' %}style="display:none;"{% endif %}>
            <label>Trailing Percentage (%)</label>
            <input type="number" step="0.01" name="trailing_percentage" id="trailing_percentage" class="form-control" value="{{ bot.trailing_stop_state.trailing_percentage if bot.has_trailing_stop and bot.trailing_stop_state.trailing_percentage else '' }}">
          </div>
          <div class="form-group" id="dollar_field" {% if not bot.has_trailing_stop or bot.trailing_stop_state.trailing_mode == 'percentage' %}style="display:none;"{% endif %}>
            <label>Trailing Dollar Amount ($)</label>
            <input type="number" step="0.01" name="trailing_dollar_amount" id="trailing_dollar_amount" class="form-control" value="{{ bot.trailing_stop_state.trailing_dollar_amount if bot.has_trailing_stop and bot.trailing_stop_state.trailing_dollar_amount else '' }}">
          </div>
          <button type="submit" class="btn btn-info btn-block"><i class="fas fa-save"></i> Save Trailing Stop</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Positions History -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-history mr-2"></i>Position History
        </h3>
        <div class="card-tools">
          <button type="button" class="btn btn-sm btn-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if positions %}
        <div class="table-responsive">
          <table class="table table-striped table-hover data-table">
            <thead>
              <tr>
                <th>Position ID</th>
                <th>Status</th>
                <th>Opened</th>
                <th>Closed</th>
                <th>Duration</th>
                <th>Account</th>
                <th>Orders</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for position in positions %}
              <tr>
                <td><strong>{{ position.id }}</strong></td>
                <td>
                  <span class="badge badge-{{ position.status_badge_class }}">
                    {{ position.status_text }}
                  </span>
                </td>
                <td>
                  <small>{{ position.opened_datetime.strftime('%Y-%m-%d %H:%M') }}</small>
                </td>
                <td>
                  {% if position.closed_datetime %}
                    <small>{{ position.closed_datetime.strftime('%Y-%m-%d %H:%M') }}</small>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <small>{{ position.duration_text }}</small>
                </td>
                <td>
                  <small>{{ position.account_name }}</small>
                </td>
                <td>
                  <span class="badge badge-info">{{ position.orders|length }} orders</span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-info" title="View Details" onclick="viewPositionDetails({{ position.id }})">
                      <i class="fas fa-eye"></i>
                    </button>
                    {% if position.active %}
                      <button class="btn btn-danger" title="Close Position" onclick="closeSpecificPosition({{ position.id }})">
                        <i class="fas fa-times-circle"></i>
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">
          <h5><i class="icon fas fa-info"></i> No Positions Found!</h5>
          This bot has no position history.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Bot control functions
function pauseBot(botId) {
    if (confirm('Are you sure you want to pause this bot?')) {
        $.post(`/bots/${botId}/pause`, function(data) {
            if (data.success) {
                showToast('success', 'Bot paused successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to pause bot');
            }
        }).fail(function() {
            showToast('error', 'Failed to pause bot');
        });
    }
}

function resumeBot(botId) {
    if (confirm('Are you sure you want to resume this bot?')) {
        $.post(`/bots/${botId}/resume`, function(data) {
            if (data.success) {
                showToast('success', 'Bot resumed successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to resume bot');
            }
        }).fail(function() {
            showToast('error', 'Failed to resume bot');
        });
    }
}

function enableBot(botId) {
    if (confirm('Are you sure you want to enable this bot?')) {
        $.post(`/bots/${botId}/enable`, function(data) {
            if (data.success) {
                showToast('success', 'Bot enabled successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to enable bot');
            }
        }).fail(function() {
            showToast('error', 'Failed to enable bot');
        });
    }
}

function viewPositionDetails(positionId) {
    alert(`Position details for ID: ${positionId} - Feature coming soon!`);
}

function closeSpecificPosition(positionId) {
    alert(`Close specific position ${positionId} - Feature coming soon!`);
}

// Toast notification function
function showToast(type, message) {
    const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';
    const toast = `
        <div class="toast ${toastClass}" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
            <div class="toast-header">
                <strong class="mr-auto">Notification</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body text-white">${message}</div>
        </div>
    `;
    
    if (!document.querySelector('.toast-container')) {
        $('body').append('<div class="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>');
    }
    
    $('.toast-container').append(toast);
    $('.toast').last().toast('show');
}

// Trailing stop mode toggle
$(document).ready(function() {
    $('#trailing_mode').on('change', function() {
        const mode = $(this).val();
        if (mode === 'percentage') {
            $('#percentage_field').show();
            $('#dollar_field').hide();
            $('#trailing_percentage').prop('required', true);
            $('#trailing_dollar_amount').prop('required', false);
        } else {
            $('#percentage_field').hide();
            $('#dollar_field').show();
            $('#trailing_percentage').prop('required', false);
            $('#trailing_dollar_amount').prop('required', true);
        }
    });
    
    // Set initial required state based on current mode
    const initialMode = $('#trailing_mode').val();
    if (initialMode === 'percentage') {
        $('#trailing_percentage').prop('required', true);
        $('#trailing_dollar_amount').prop('required', false);
    } else {
        $('#trailing_percentage').prop('required', false);
        $('#trailing_dollar_amount').prop('required', true);
    }
});
</script>
{% endblock %}
