{% extends "base.html" %}

{% block title %}Bots - {{ app_name }}{% endblock %}

{% block page_title %}Bot Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Home</a></li>
<li class="breadcrumb-item active">Bots</li>
{% endblock %}

{% block content %}
<!-- Bulk Actions Row -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-cogs mr-2"></i>Bulk Actions
        </h3>
        <div class="card-tools">
          <div class="btn-group btn-group-sm" role="group" aria-label="Filters">
            <a href="{{ url_for('bots') }}" class="btn btn-outline-secondary {% if not current_filter %}active{% endif %}">
              All <span class="badge badge-light ml-1">{{ all_total_bots }}</span>
            </a>
            <a href="{{ url_for('bots', filter='active') }}" class="btn btn-outline-success {% if current_filter=='active' %}active{% endif %}">
              Active <span class="badge badge-light ml-1">{{ all_active_bots }}</span>
            </a>
            <a href="{{ url_for('bots', filter='inactive') }}" class="btn btn-outline-warning {% if current_filter=='inactive' %}active{% endif %}">
              Inactive <span class="badge badge-light ml-1">{{ all_inactive_bots }}</span>
            </a>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-warning" onclick="pauseAllBots()">
            <i class="fas fa-pause"></i> Pause All Bots
          </button>
          <button type="button" class="btn btn-success" onclick="resumeAllBots()">
            <i class="fas fa-play"></i> Resume All Bots
          </button>
          <button type="button" class="btn btn-danger" onclick="closeAllPositions()">
            <i class="fas fa-times-circle"></i> Close All Positions
          </button>
        </div>
        <div class="float-right">
          <button type="button" class="btn btn-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bots by Account -->
{% if bots_by_account %}
  {% for account, bots in bots_by_account.items() %}
  <div class="card collapsed-card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fas fa-university mr-2"></i>{{ account.name }} ({{ account.account_id }})
      </h3>
      <div class="card-tools">
        <span class="badge badge-info mr-2">{{ bots|length }} bots</span>
        <span class="badge badge-success mr-2">{{ account.active_positions }} active positions</span>
        <button type="button" class="btn btn-tool" data-card-widget="collapse">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    </div>
    <div class="card-body" style="display: none;">
      {% if bots %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Bot Name</th>
              <th>Status</th>
              <th>State</th>
              <th>Active Positions</th>
              <th>Total Positions</th>
              <th>Trailing Stop</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for bot in bots %}
            <tr>
              <td>
                <strong><a href="{{ url_for('bot_detail', bot_id=bot.id) }}">{{ bot.name }}</a></strong>
                <br><small class="text-muted">ID: {{ bot.id }}</small>
              </td>
              <td>
                <span class="badge badge-{{ bot.status_badge_class }}">
                  {{ bot.status_text }}
                </span>
              </td>
              <td>
                <span class="badge badge-{{ bot.state_badge_class }}">
                  {{ bot.state }}
                </span>
              </td>
              <td>
                <span class="badge badge-{{ 'success' if bot.active_positions_count > 0 else 'secondary' }}">
                  {{ bot.active_positions_count }}
                </span>
              </td>
              <td>
                <span class="badge badge-info">
                  {{ bot.total_positions }}
                </span>
              </td>
              <td>
                {% if bot.has_trailing_stop %}
                  <span class="badge badge-{{ bot.trailing_stop_state.status_badge_class }}">
                    {{ bot.trailing_stop_state.status_text }}
                  </span>
                {% else %}
                  <span class="text-muted">None</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{{ url_for('bot_detail', bot_id=bot.id) }}" class="btn btn-info" title="View Details">
                    <i class="fas fa-eye"></i>
                  </a>
                  {% if bot.paused %}
                    <button class="btn btn-success" title="Resume Bot" onclick="resumeBot({{ bot.id }})">
                      <i class="fas fa-play"></i>
                    </button>
                  {% elif bot.enabled %}
                    <button class="btn btn-warning" title="Pause Bot" onclick="pauseBot({{ bot.id }})">
                      <i class="fas fa-pause"></i>
                    </button>
                    <button class="btn btn-secondary" title="Enable Bot" onclick="enableBot({{ bot.id }})">
                      <i class="fas fa-power-off"></i>
                    </button>
                  {% endif %}
                  {% if bot.active_positions_count > 0 %}
                    <button class="btn btn-danger" title="Close Position" onclick="closePosition({{ bot.id }})">
                      <i class="fas fa-times-circle"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">
        <h5><i class="icon fas fa-info"></i> No Bots Found!</h5>
        No bots are associated with this account.
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
{% else %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="alert alert-info">
          <h5><i class="icon fas fa-info"></i> No Bots Found!</h5>
          No bots are currently configured in the system.
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Summary Statistics -->
<div class="row">
  <div class="col-lg-3 col-6">
  <a href="{{ url_for('bots') }}" class="text-reset" style="text-decoration:none;">
  <div class="small-box bg-info" style="cursor:pointer;">
      <div class="inner">
        <h3>{{ total_bots }}</h3>
        <p>Total Bots</p>
      </div>
      <div class="icon">
        <i class="fas fa-robot"></i>
      </div>
    </div>
  </a>
  </div>
  
  <div class="col-lg-3 col-6">
  <a href="{{ url_for('bots', filter='active') }}" class="text-reset" style="text-decoration:none;">
  <div class="small-box bg-success" style="cursor:pointer;">
      <div class="inner">
        <h3>{{ active_bots }}</h3>
        <p>Active Bots</p>
      </div>
      <div class="icon">
        <i class="fas fa-play"></i>
      </div>
    </div>
  </a>
  </div>
  
  <div class="col-lg-3 col-6">
  <a href="{{ url_for('bots', filter='inactive') }}" class="text-reset" style="text-decoration:none;">
  <div class="small-box bg-warning" style="cursor:pointer;">
      <div class="inner">
    <h3>{{ paused_bots }}</h3>
    <p>Inactive Bots</p>
      </div>
      <div class="icon">
        <i class="fas fa-pause"></i>
      </div>
    </div>
  </a>
  </div>
  
  <div class="col-lg-3 col-6">
  <a href="{{ url_for('accounts') }}" class="text-reset" style="text-decoration:none;">
  <div class="small-box bg-secondary" style="cursor:pointer;">
      <div class="inner">
        <h3>{{ total_accounts }}</h3>
        <p>Accounts</p>
      </div>
      <div class="icon">
        <i class="fas fa-university"></i>
      </div>
    </div>
  </a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Bot control functions
function pauseBot(botId) {
    if (confirm('Are you sure you want to pause this bot?')) {
        $.post(`/bots/${botId}/pause`, function(data) {
            if (data.success) {
                showToast('success', 'Bot paused successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to pause bot');
            }
        }).fail(function() {
            showToast('error', 'Failed to pause bot');
        });
    }
}

function resumeBot(botId) {
    if (confirm('Are you sure you want to resume this bot?')) {
        $.post(`/bots/${botId}/resume`, function(data) {
            if (data.success) {
                showToast('success', 'Bot resumed successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to resume bot');
            }
        }).fail(function() {
            showToast('error', 'Failed to resume bot');
        });
    }
}

function enableBot(botId) {
    if (confirm('Are you sure you want to enable this bot?')) {
        $.post(`/bots/${botId}/enable`, function(data) {
            if (data.success) {
                showToast('success', 'Bot enabled successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to enable bot');
            }
        }).fail(function() {
            showToast('error', 'Failed to enable bot');
        });
    }
}

function closePosition(botId) {
    if (confirm('Are you sure you want to close the active position for this bot?')) {
        $.post(`/bots/${botId}/close-position`, function(data) {
            if (data.success) {
                showToast('success', 'Position closed successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to close position');
            }
        }).fail(function() {
            showToast('error', 'Failed to close position');
        });
    }
}

// Bulk actions
function pauseAllBots() {
    if (confirm('Are you sure you want to pause ALL active bots?')) {
        $.post('{{ url_for('pause_all') }}', function(data) {
            if (data.success) {
                showToast('success', `${data.count} bots paused successfully`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to pause bots');
            }
        }).fail(function() {
            showToast('error', 'Failed to pause bots');
        });
    }
}

function resumeAllBots() {
    if (confirm('Are you sure you want to resume ALL paused bots?')) {
        $.post('{{ url_for('resume_all') }}', function(data) {
            if (data.success) {
                showToast('success', `${data.count} bots resumed successfully`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to resume bots');
            }
        }).fail(function() {
            showToast('error', 'Failed to resume bots');
        });
    }
}

function closeAllPositions() {
    if (confirm('Are you sure you want to close ALL active positions? This action cannot be undone!')) {
        $.post('{{ url_for('close_all') }}', function(data) {
            if (data.success) {
                showToast('success', `${data.count} positions closed successfully`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', data.message || 'Failed to close positions');
            }
        }).fail(function() {
            showToast('error', 'Failed to close positions');
        });
    }
}

// Toast notification function
function showToast(type, message) {
    const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';
    const toast = `
        <div class="toast ${toastClass}" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
            <div class="toast-header">
                <strong class="mr-auto">Notification</strong>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body text-white">${message}</div>
        </div>
    `;
    
    if (!document.querySelector('.toast-container')) {
        $('body').append('<div class="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>');
    }
    
    $('.toast-container').append(toast);
    $('.toast').last().toast('show');
}
</script>
{% endblock %}
